<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Méthodes par arbres - 3&nbsp; Gradient boosting</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./02-forets.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "Pas de résultats",
    "search-matching-documents-text": "documents trouvés",
    "search-copy-link-title": "Copier le lien vers la recherche",
    "search-hide-matches-text": "Cacher les correspondances additionnelles",
    "search-more-match-text": "correspondance de plus dans ce document",
    "search-more-matches-text": "correspondances de plus dans ce document",
    "search-clear-button-title": "Effacer",
    "search-detached-cancel-button-title": "Annuler",
    "search-submit-button-title": "Envoyer",
    "search-label": "Recherche"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="style.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Basculer la barre latérale" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./02-forets.html">Agrégation</a></li><li class="breadcrumb-item"><a href="./03-boosting.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Gradient boosting</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Basculer la barre latérale" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Méthodes par arbres</a> 
        <div class="sidebar-tools-main">
    <div class="dropdown">
      <a href="" title="Download" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download"><i class="bi bi-download"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="./Méthodes-par-arbres.pdf">
              <i class="bi bi-bi-file-pdf pe-1"></i>
            Download PDF
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="./Méthodes-par-arbres.epub">
              <i class="bi bi-bi-journal pe-1"></i>
            Download ePub
            </a>
          </li>
      </ul>
    </div>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-1" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-1">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Recherche"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Présentation</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Arbres</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-arbres.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Méthodes CART</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Agrégation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-forets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Forêts aléatoires</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-boosting.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Gradient boosting</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Références</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table des matières</h2>
   
  <ul>
  <li><a href="#sec-sinusgbm" id="toc-sec-sinusgbm" class="nav-link active" data-scroll-target="#sec-sinusgbm"><span class="header-section-number">3.1</span> Un exemple simple en régression</a></li>
  <li><a href="#sec-gbmspam" id="toc-sec-gbmspam" class="nav-link" data-scroll-target="#sec-gbmspam"><span class="header-section-number">3.2</span> Adaboost et logitboost pour la classification binaire.</a></li>
  <li><a href="#comparaison-de-méthodes" id="toc-comparaison-de-méthodes" class="nav-link" data-scroll-target="#comparaison-de-méthodes"><span class="header-section-number">3.3</span> Comparaison de méthodes</a></li>
  <li><a href="#xgboost" id="toc-xgboost" class="nav-link" data-scroll-target="#xgboost"><span class="header-section-number">3.4</span> Xgboost</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Gradient boosting</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="cell">

</div>
<style>
div.correction {
  color: black;
  background-color: #F0F0F0;
  font-style: normal;
  /*display: none;*/
}

.corR {
  font-style: italic;
  /*display: none;*/
}

.algo{
  color: black;
  background-color: #F9C4ED;
  font-style: normal;
}
</style>
<p>Les algorithmes de gradient boosting permettent de minimiser des pertes empiriques de la forme <span class="math display">\[\frac{1}{n}\sum_{i=1}^n\ell(y_i,f(x_i)).\]</span> où <span class="math inline">\(\ell:\mathbb R\times\mathbb R\to\mathbb R\)</span> est une fonction de coût convexe en son second argument. Il existe plusieurs type d’algorithmes boosting. Un des plus connus et utilisés a été proposé par <span class="citation" data-cites="fri01">Friedman (<a href="references.html#ref-fri01" role="doc-biblioref">2001</a>)</span>, c’est la version que nous étudions dans cette partie.</p>
<p>Cette approche propose de chercher la meilleure combinaison linéaire d’arbres binaires, c’est-à-dire que l’on recherche <span class="math inline">\(g(x)=\sum_{m=1}^M\alpha_mh_m(x)\)</span> qui minimise <span class="math display">\[\mathcal R_n(g)=\frac{1}{n}\sum_{i=1}^n\ell(y_i,g(x_i)).\]</span> Optimiser sur toutes les combinaisons d’arbres binaires se révélant souvent trop compliqué, <span class="citation" data-cites="fri01">Friedman (<a href="references.html#ref-fri01" role="doc-biblioref">2001</a>)</span> utilise une descente de gradient pour construire la combinaison d’arbres de façon récursive. L’algorithme est le suivant :</p>
<div class="algo">
<p><strong>Entrées</strong> :</p>
<ul>
<li><span class="math inline">\(d_n=(x_1,y_1),\dots,(x_n,y_n)\)</span> l’échantillon, <span class="math inline">\(\lambda\)</span> un paramètre de régularisation tel que <span class="math inline">\(0\lt\lambda\leq 1\)</span>.</li>
<li><span class="math inline">\(M\in\mathbb N\)</span> le nombre d’itérations.</li>
<li>paramètres de l’arbre (nombre de coupures…)</li>
</ul>
<p><strong>Itérations</strong> :</p>
<ol type="1">
<li>Initialisation : <span class="math inline">\(g_0(.)=\mathop{\mathrm{argmin}}_c \frac{1}{n}\sum_{i=1}^n \ell(y_i,c)\)</span></li>
<li>Pour <span class="math inline">\(m=1\)</span> à <span class="math inline">\(M\)</span> :
<ol type="a">
<li>Calculer l’opposé du gradient <span class="math inline">\(-\frac{\partial}{\partial g(x_i)}\ell(y_i,g(x_i))\)</span> et l’évaluer aux points <span class="math inline">\(g_{m-1}(x_i)\)</span> : <span class="math display">\[U_i=-\frac{\partial}{\partial g(x_i)}\ell(y_i,g(x_i)) _{\Big |g(x_i)=g_{m-1}(x_i)},\quad i=1,\dots,n.\]</span></li>
<li>Ajuster un arbre sur l’échantillon <span class="math inline">\((x_1,U_1),\dots,(x_n,U_n)\)</span>, on le note <span class="math inline">\(h_m\)</span>.</li>
<li>Mise à jour : <span class="math inline">\(g_m(x)=g_{m-1}(x)+\lambda h_m(x)\)</span>.</li>
</ol></li>
</ol>
<p><strong>Sortie</strong> : la suite <span class="math inline">\((g_m(x))_m\)</span>.</p>
</div>
<p>Sur <strong>R</strong> On peut utiliser différents packages pour faire du gradient boosting. Nous utilisons ici le package <strong>gbm</strong> <span class="citation" data-cites="rid06">(<a href="references.html#ref-rid06" role="doc-biblioref">Ridgeway 2006</a>)</span>.</p>
<section id="sec-sinusgbm" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="sec-sinusgbm"><span class="header-section-number">3.1</span> Un exemple simple en régression</h2>
<p>On considère un jeu de données <span class="math inline">\((x_i,y_i),i=1,\dots,200\)</span> issu d’un modèle de régression <span class="math display">\[y_i=m(x_i)+\varepsilon_i\]</span> où la vraie fonction de régression est la fonction <strong>sinus</strong> (mais on va faire comme si on ne le savait pas).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>pi,<span class="dv">2</span><span class="sc">*</span>pi,<span class="at">by=</span><span class="fl">0.01</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">sin</span>(x)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">200</span>,<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>pi,<span class="dv">2</span><span class="sc">*</span>pi)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">sin</span>(X)<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">200</span>,<span class="at">sd=</span><span class="fl">0.2</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>df1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(X,Y)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">X=</span>x,<span class="at">Y=</span>y)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df1)<span class="sc">+</span><span class="fu">aes</span>(<span class="at">x=</span>X,<span class="at">y=</span>Y)<span class="sc">+</span><span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data=</span>df2,<span class="at">linewidth=</span><span class="dv">1</span>)<span class="sc">+</span><span class="fu">xlab</span>(<span class="st">""</span>)<span class="sc">+</span><span class="fu">ylab</span>(<span class="st">""</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>p1</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<ol type="1">
<li><p>Rappeler ce que siginifie le <span class="math inline">\(L_2\)</span>-boosting.</p>
<div class="corR">
<p>Il s’agit de l’algorithme de gradient boosting présenté ci-dessus appliqué à la fonction de perte <span class="math display">\[\ell(y,f(x))=\frac{1}{2}(y-f(x))^2.\]</span></p>
</div></li>
<li><p>A l’aide de la fonction <strong>gbm</strong> du package <strong>gbm</strong> construire un algorithme de <span class="math inline">\(L_2\)</span>-boosting. On utilisera 500000 itérations et gardera les autres valeurs par défaut de paramètres, à l’exception de <code>bag.fraction</code> qu’on prendra égal à 1.</p>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gbm)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>L2boost <span class="ot">&lt;-</span> <span class="fu">gbm</span>(Y<span class="sc">~</span>.,<span class="at">data=</span>df1,<span class="at">n.trees =</span> <span class="dv">500000</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">distribution=</span><span class="st">"gaussian"</span>,<span class="at">bag.fraction =</span> <span class="dv">1</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>Visualiser l’estimateur à la première itération. On pourra faire un <strong>predict</strong> avec l’option <code>n.trees</code> ou utiliser directement la fonction <strong>plot.gbm</strong> avec l’option <code>n.trees</code>.</p>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>prev1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(L2boost,<span class="at">newdata=</span>df2,<span class="at">n.trees=</span><span class="dv">1</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>df3 <span class="ot">&lt;-</span> df2 <span class="sc">|&gt;</span> <span class="fu">rename</span>(<span class="at">vraie=</span>Y) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="st">`</span><span class="at">M=1</span><span class="st">`</span><span class="ot">=</span>prev1)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>df4 <span class="ot">&lt;-</span> df3 <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="sc">-</span>X,<span class="at">names_to=</span><span class="st">"courbes"</span>,<span class="at">values_to=</span><span class="st">"prev"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df4)<span class="sc">+</span><span class="fu">aes</span>(<span class="at">x=</span>X,<span class="at">y=</span>prev,<span class="at">color=</span>courbes)<span class="sc">+</span><span class="fu">geom_line</span>(<span class="at">size=</span><span class="dv">1</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="corR">
<p>On remarque que l’estimateur est un arbre avec une seule coupure. On aurait aussi pu utiliser :</p>
</div>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(L2boost,<span class="at">n.trees=</span><span class="dv">1</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div></li>
<li><p>Faire de même pour les itérations 1000 et 500000.</p>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>prev1000 <span class="ot">&lt;-</span> <span class="fu">predict</span>(L2boost,<span class="at">newdata=</span>df2,<span class="at">n.trees=</span><span class="dv">1000</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>prev500000 <span class="ot">&lt;-</span> <span class="fu">predict</span>(L2boost,<span class="at">newdata=</span>df2,<span class="at">n.trees=</span><span class="dv">500000</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>df31 <span class="ot">&lt;-</span> df3 <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="st">`</span><span class="at">M=1000</span><span class="st">`</span><span class="ot">=</span>prev1000,<span class="st">`</span><span class="at">M=500000</span><span class="st">`</span><span class="ot">=</span>prev500000)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>df41 <span class="ot">&lt;-</span> df31 <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="sc">-</span>X,<span class="at">names_to=</span><span class="st">"courbes"</span>,<span class="at">values_to=</span><span class="st">"prev"</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df41)<span class="sc">+</span><span class="fu">aes</span>(<span class="at">x=</span>X,<span class="at">y=</span>prev,<span class="at">color=</span>courbes)<span class="sc">+</span><span class="fu">geom_line</span>(<span class="at">size=</span><span class="dv">1</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="corR">
<p>On sur-ajuste lorsque le nombre d’itérations est trop important.</p>
</div></li>
<li><p>Sélectionner le nombre d’itérations par la procédure de votre choix.</p>
<div class="corR">
<p>On propose de faire une validation hold out. C’est assez facile avec <strong>gbm</strong> il suffit de renseigner l’option <code>train.fraction</code> de <strong>gbm</strong>.</p>
</div>
<div class="cell" data-teacher="true" data-hash="03-boosting_cache/html/unnamed-chunk-11_84a699658b56c2400d60914a5e8294bc">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#parallel:::setDefaultClusterOptions(setup_strategy = "sequential")</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>L2boost.sel <span class="ot">&lt;-</span> <span class="fu">gbm</span>(Y<span class="sc">~</span>.,<span class="at">data=</span>df1,<span class="at">n.trees =</span> <span class="dv">10000</span>,<span class="at">distribution=</span><span class="st">"gaussian"</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">bag.fraction =</span> <span class="dv">1</span>,<span class="at">train.fraction=</span><span class="fl">0.75</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>iter_opt <span class="ot">&lt;-</span> <span class="fu">gbm.perf</span>(L2boost.sel)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div></li>
<li><p>Représenter l’estimateur sélectionné.</p>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>prev_opt <span class="ot">&lt;-</span> <span class="fu">predict</span>(L2boost.sel,<span class="at">newdata=</span>df2,<span class="at">n.trees=</span>iter_opt)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>df5 <span class="ot">&lt;-</span> df2 <span class="sc">|&gt;</span> <span class="fu">rename</span>(<span class="at">vraie=</span>Y) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">Mopt=</span>prev_opt)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>df51 <span class="ot">&lt;-</span> df5 <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="sc">-</span>X,<span class="at">names_to=</span><span class="st">"courbes"</span>,<span class="at">values_to=</span><span class="st">"prev"</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df51)<span class="sc">+</span><span class="fu">aes</span>(<span class="at">x=</span>X,<span class="at">y=</span>prev,<span class="at">color=</span>courbes)<span class="sc">+</span><span class="fu">geom_line</span>(<span class="at">size=</span><span class="dv">1</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div></li>
</ol>
</section>
<section id="sec-gbmspam" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="sec-gbmspam"><span class="header-section-number">3.2</span> Adaboost et logitboost pour la classification binaire.</h2>
<p>On considère le jeu de données <strong>spam</strong> du package <strong>kernlab</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kernlab)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(spam)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>spam <span class="ot">&lt;-</span> spam[<span class="fu">sample</span>(<span class="fu">nrow</span>(spam)),]</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li><p>Exécuter la commande et commenter la sortie.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>model_ada1 <span class="ot">&lt;-</span> <span class="fu">gbm</span>(type<span class="sc">~</span>.,<span class="at">data=</span>spam,<span class="at">distribution=</span><span class="st">"adaboost"</span>,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">interaction.depth=</span><span class="dv">2</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">shrinkage=</span><span class="fl">0.05</span>,<span class="at">n.trees=</span><span class="dv">500</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="corR">
<p>On obtient le message d’erreur suivant :</p>
</div>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>model_ada1 <span class="ot">&lt;-</span> <span class="fu">gbm</span>(type<span class="sc">~</span>.,<span class="at">data=</span>spam,<span class="at">distribution=</span><span class="st">"adaboost"</span>,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">interaction.depth=</span><span class="dv">2</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">shrinkage=</span><span class="fl">0.05</span>,<span class="at">n.trees=</span><span class="dv">500</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in gbm.fit(x = x, y = y, offset = offset, distribution = distribution, : This version of AdaBoost requires the response to be in {0,1}</code></pre>
</div>
</div></li>
<li><p>Proposer une correction permettant de faire fonctionner l’algorithme.</p>
<div class="corR">
<p>Il est nécessaire que la variable qualitative à expliquer soit codée 0-1 pour adaboost.</p>
</div>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>spam1 <span class="ot">&lt;-</span> spam</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>spam1<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(spam1<span class="sc">$</span>type)<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>model_ada1 <span class="ot">&lt;-</span> <span class="fu">gbm</span>(type<span class="sc">~</span>.,<span class="at">data=</span>spam1,<span class="at">distribution=</span><span class="st">"adaboost"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">interaction.depth=</span><span class="dv">2</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">shrinkage=</span><span class="fl">0.05</span>,<span class="at">n.trees=</span><span class="dv">500</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>Expliciter le modèle ajusté par la commande précédente.</p>
<div class="corR">
<p>L’algorithme <strong>gbm</strong> est une descente de gradient qui minimise la fonction de perte <span class="math display">\[\frac{1}{n}\sum_{i=1}^n \ell(y_i,g(x_i)).\]</span> Dans le cas de <strong>adaboost</strong> on utilise la perte exponentielle : <span class="math inline">\(\ell(y,g(x))=\exp(-yg(x))\)</span>.</p>
</div></li>
<li><p>Effectuer un <strong>summary</strong> du modèle ajusté. Expliquer la sortie.</p>
<div class="cell" data-teacher="true" data-max.height="500px">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_ada1)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                var     rel.inf
charExclamation     charExclamation 20.04035224
charDollar               charDollar 17.51535261
remove                       remove 11.51692621
free                           free  7.49397637
hp                               hp  6.25654932
capitalLong             capitalLong  5.42905223
capitalAve               capitalAve  4.69521299
your                           your  4.23371585
george                       george  2.50300727
edu                             edu  2.19692796
our                             our  1.99655393
money                         money  1.79063219
email                         email  1.51773292
capitalTotal           capitalTotal  1.43872496
internet                   internet  1.12579132
receive                     receive  0.97001932
will                           will  0.94015881
you                             you  0.89915372
business                   business  0.84418397
re                               re  0.82959153
num1999                     num1999  0.80016393
num650                       num650  0.79468746
meeting                     meeting  0.69494729
num000                       num000  0.56448978
charRoundbracket   charRoundbracket  0.39921437
report                       report  0.38621968
charSemicolon         charSemicolon  0.29835251
credit                       credit  0.27841575
over                           over  0.27064075
order                         order  0.26017226
mail                           mail  0.22398163
technology               technology  0.10340435
hpl                             hpl  0.10151723
original                   original  0.09615196
font                           font  0.09539134
make                           make  0.08995855
project                     project  0.07970985
all                             all  0.05392468
people                       people  0.05359692
address                     address  0.04690996
parts                         parts  0.04260362
conference               conference  0.02037549
num85                         num85  0.01155488
num3d                         num3d  0.00000000
addresses                 addresses  0.00000000
lab                             lab  0.00000000
labs                           labs  0.00000000
telnet                       telnet  0.00000000
num857                       num857  0.00000000
data                           data  0.00000000
num415                       num415  0.00000000
pm                               pm  0.00000000
direct                       direct  0.00000000
cs                               cs  0.00000000
table                         table  0.00000000
charSquarebracket charSquarebracket  0.00000000
charHash                   charHash  0.00000000</code></pre>
</div>
</div>
<div class="corR">
<p>On obtient un indicateur qui permet de mesurer l’importance des variable dans la construction de la méthode.</p>
</div></li>
<li><p>Utiliser la fonction <strong>vip</strong> du package <strong>vip</strong> pour retrouver ce sorties.</p>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">vip</span>(model_ada1,<span class="at">num_features =</span> 20L)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div></li>
<li><p>Sélectionner le nombre d’itérations pour l’algorithme adaboost en faisant une validation croisée 5 blocs.</p>
<div class="cell" data-teacher="true" data-hash="03-boosting_cache/html/cv-ada1_896e482083455887a2e505fe1bba5963">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>model_ada2 <span class="ot">&lt;-</span> <span class="fu">gbm</span>(type<span class="sc">~</span>.,<span class="at">data=</span>spam1,<span class="at">distribution=</span><span class="st">"adaboost"</span>,</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">interaction.depth=</span><span class="dv">2</span>,<span class="at">bag.fraction=</span><span class="dv">1</span>,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">cv.folds =</span> <span class="dv">5</span>,<span class="at">n.trees=</span><span class="dv">500</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="fu">gbm.perf</span>(model_ada2)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/cv-ada1-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 233</code></pre>
</div>
</div></li>
<li><p>Pour l’estimateur sélectionné, calculer la prévision (label et probabilité d’être un spam) de l’individu suivant :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>xnew <span class="ot">&lt;-</span> spam[<span class="dv">1000</span>,<span class="sc">-</span><span class="dv">58</span>]</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="corR">
<p>On obtient la probabilité d’être spam avec</p>
</div>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(model_ada2,<span class="at">newdata=</span>xnew,<span class="at">type=</span><span class="st">"response"</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0007065154</code></pre>
</div>
</div>
<div class="corR">
<p>On prédira donc <code>nonspam</code>.</p>
</div></li>
<li><p>Faire la même procédure en changeant la valeur du paramètre <strong>shrinkage</strong> (par exemple 0.05 et 0.5). Interpréter.</p>
<div class="cell" data-teacher="true" data-hash="03-boosting_cache/html/cv-ada2_818ba919594e4d6ddc735cdbda5624aa">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>model_ada3 <span class="ot">&lt;-</span> <span class="fu">gbm</span>(type<span class="sc">~</span>.,<span class="at">data=</span>spam1,<span class="at">distribution=</span><span class="st">"adaboost"</span>,</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">interaction.depth=</span><span class="dv">2</span>,<span class="at">bag.fraction=</span><span class="dv">1</span>,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">cv.folds =</span> <span class="dv">5</span>,<span class="at">n.trees=</span><span class="dv">500</span>,<span class="at">shrinkage=</span><span class="fl">0.05</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">gbm.perf</span>(model_ada3)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/cv-ada2-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 370</code></pre>
</div>
</div>
<div class="cell" data-teacher="true" data-hash="03-boosting_cache/html/cv-ada3_e6d86b153e923308a318a834dc1a0a71">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>model_ada4 <span class="ot">&lt;-</span> <span class="fu">gbm</span>(type<span class="sc">~</span>.,<span class="at">data=</span>spam1,<span class="at">distribution=</span><span class="st">"adaboost"</span>,</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">interaction.depth=</span><span class="dv">2</span>,<span class="at">bag.fraction=</span><span class="dv">1</span>,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">cv.folds =</span> <span class="dv">5</span>,<span class="at">n.trees=</span><span class="dv">500</span>,<span class="at">shrinkage=</span><span class="fl">0.5</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="fu">gbm.perf</span>(model_ada4)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/cv-ada3-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 36</code></pre>
</div>
</div>
<div class="corR">
<p>Le nombre d’itérations optimal augmente lorsque <strong>shrinkage</strong> diminue. C’est logique car ce dernier paramètre contrôle la vitesse de descente de gradient : plus il est grand, plus on minimise vite et moins on itère. Il faut néanmoins veiller à ne pas le prendre trop petit pour avoir un estimateur stable. Ici, 0.05 semble être une bonne valeur.</p>
</div></li>
<li><p>Expliquer la différence entre <strong>adaboost</strong> et <strong>logitboost</strong> et précisez comment on peut mettre en œuvre ce dernier algorithme.</p>
<div class="corR">
<p>La seule différence se situe au niveau de la <strong>fonction de perte</strong>, adaboost utilise <span class="math display">\[\exp(-yg(x))\]</span> tandis que logitboost utilise <span class="math display">\[\log(1+\exp(-2yg(x)))\]</span> Avec <strong>gbm</strong> il faudra utiliser l’option <code>distribution="bernoulli"</code> pour faire du logitboost, par exemple :</p>
</div>
<div class="cell" data-teacher="true" data-hash="03-boosting_cache/html/cv-logitboost_361713939e9486bc6ad897963c12d220">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4321</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>logitboost <span class="ot">&lt;-</span> <span class="fu">gbm</span>(type<span class="sc">~</span>.,<span class="at">data=</span>spam1,<span class="at">distribution=</span><span class="st">"bernoulli"</span>,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">interaction.depth=</span><span class="dv">2</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">bag.fraction=</span><span class="dv">1</span>,<span class="at">cv.folds =</span> <span class="dv">5</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">n.trees=</span><span class="dv">500</span>,<span class="at">shrinkage=</span><span class="fl">0.4</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="fu">gbm.perf</span>(logitboost)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/cv-logitboost-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 288</code></pre>
</div>
</div></li>
</ol>
</section>
<section id="comparaison-de-méthodes" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="comparaison-de-méthodes"><span class="header-section-number">3.3</span> Comparaison de méthodes</h2>
<p>On reprend les données <code>spam</code> de l’exercice précédent et on les coupe en un échantillon d’apprentissage pour entraîner les algorithmes et un échantillon test pour les comparer :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>perm <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(spam))</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>app <span class="ot">&lt;-</span> spam[perm[<span class="dv">1</span><span class="sc">:</span><span class="dv">3000</span>],]</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> spam[<span class="sc">-</span>perm[<span class="dv">1</span><span class="sc">:</span><span class="dv">3000</span>],]</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li><p>Sur les données d’apprentissage uniquement, entraîner</p>
<ul>
<li><p>l’algorithme <strong>adaboost</strong> en sélectionnant le nombre d’itérations par validation croisée</p></li>
<li><p>l’algorithme <strong>logitboost</strong> en sélectionnant le nombre d’itérations par validation croisée</p></li>
<li><p>une <strong>forêt aléatoire</strong> avec les paramètres par défaut</p></li>
<li><p>un <strong>arbre CART</strong></p></li>
</ul>
<div class="cell" data-teacher="true" data-hash="03-boosting_cache/html/unnamed-chunk-25_6355a5247d76bd98040cc18c2e820ccc">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4321</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>app1 <span class="ot">&lt;-</span> app <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">type=</span><span class="fu">as.numeric</span>(type)<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>model_ada <span class="ot">&lt;-</span> <span class="fu">gbm</span>(type<span class="sc">~</span>.,<span class="at">data=</span>app1,<span class="at">distribution=</span><span class="st">"adaboost"</span>,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">interaction.depth=</span><span class="dv">3</span>,<span class="at">bag.fraction=</span><span class="dv">1</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">shrinkage =</span> <span class="fl">0.05</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">cv.folds =</span> <span class="dv">5</span>,<span class="at">n.trees=</span><span class="dv">500</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>nb_ada <span class="ot">&lt;-</span> <span class="fu">gbm.perf</span>(model_ada)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-teacher="true" data-hash="03-boosting_cache/html/unnamed-chunk-27_1ccc77fbe9062ae5aaf6ca53689174f2">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">5432</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>model_logit <span class="ot">&lt;-</span> <span class="fu">gbm</span>(type<span class="sc">~</span>.,<span class="at">data=</span>app1,<span class="at">distribution=</span><span class="st">"bernoulli"</span>,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">interaction.depth=</span><span class="dv">3</span>,<span class="at">bag.fraction=</span><span class="dv">1</span>,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">cv.folds =</span> <span class="dv">5</span>,<span class="at">n.trees=</span><span class="dv">800</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>nb_logit <span class="ot">&lt;-</span> <span class="fu">gbm.perf</span>(model_logit)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>foret <span class="ot">&lt;-</span> <span class="fu">ranger</span>(type<span class="sc">~</span>.,<span class="at">data=</span>app,<span class="at">probability=</span><span class="cn">TRUE</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>arbre <span class="ot">&lt;-</span> <span class="fu">rpart</span>(type<span class="sc">~</span>.,<span class="at">data=</span>app,<span class="at">cp=</span><span class="fl">1e-8</span>,<span class="at">minsplit=</span><span class="dv">2</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>cp_opt <span class="ot">&lt;-</span> arbre<span class="sc">$</span>cptable <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(xerror<span class="sc">==</span><span class="fu">min</span>(xerror)) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(CP) <span class="sc">|&gt;</span> </span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>()</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>arbre.opt <span class="ot">&lt;-</span> <span class="fu">prune</span>(arbre,<span class="at">cp=</span>cp_opt)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>Pour les 4 algorithmes, calculer, pour tous les individus de l’échantillon <code>test</code>, la probabilité que ce soit un spam. On pourra stocker toutes ces probabilités dans un même <code>tibble</code>.</p>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>prob <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">ada=</span><span class="fu">predict</span>(model_ada,<span class="at">newdata=</span>test,<span class="at">n.trees=</span>nb_ada,</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">type=</span><span class="st">"response"</span>),</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">logit=</span><span class="fu">predict</span>(model_logit,<span class="at">newdata=</span>test,<span class="at">n.trees=</span>nb_logit,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">type=</span><span class="st">"response"</span>),</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">foret=</span><span class="fu">predict</span>(foret,<span class="at">data=</span>test)<span class="sc">$</span>prediction[,<span class="dv">2</span>],</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">arbre=</span><span class="fu">predict</span>(arbre.opt,<span class="at">newdata=</span>test)[,<span class="dv">2</span>],</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">obs=</span>test<span class="sc">$</span>type)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>Comparer les 3 algorithmes avec la courbe ROC, l’AUC et l’erreur de classification.</p>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>prob1 <span class="ot">&lt;-</span> prob <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="sc">-</span>obs,<span class="at">names_to=</span><span class="st">"Methode"</span>,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">values_to=</span><span class="st">"score"</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>prob1 <span class="sc">|&gt;</span> <span class="fu">group_by</span>(Methode) <span class="sc">|&gt;</span> </span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(<span class="at">truth=</span>obs,score,<span class="at">event_level=</span><span class="st">"second"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>prob1 <span class="sc">|&gt;</span> <span class="fu">group_by</span>(Methode) <span class="sc">|&gt;</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_auc</span>(<span class="at">truth=</span>obs,score,<span class="at">event_level=</span><span class="st">"second"</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(.estimate))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
  Methode .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 logit   roc_auc binary         0.989
2 foret   roc_auc binary         0.987
3 ada     roc_auc binary         0.986
4 arbre   roc_auc binary         0.944</code></pre>
</div>
</div>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>prob1 <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">class=</span><span class="fu">recode</span>(<span class="fu">round</span>(score),</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>                             <span class="st">`</span><span class="at">0</span><span class="st">`</span><span class="ot">=</span><span class="st">"nonspam"</span>,<span class="st">`</span><span class="at">1</span><span class="st">`</span><span class="ot">=</span><span class="st">"spam"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Methode) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">err=</span><span class="fu">mean</span>(class<span class="sc">!=</span>obs)) <span class="sc">|&gt;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(err)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  Methode    err
  &lt;chr&gt;    &lt;dbl&gt;
1 logit   0.0412
2 ada     0.0525
3 foret   0.0525
4 arbre   0.0750</code></pre>
</div>
</div></li>
<li><p>Comment aurait-on pu faire pour obtenir des résultats plus précis ?</p>
<div class="corR">
<p>Avec une validation croisée plutôt qu’un simple découpage apprentissage/test.</p>
</div>
<div class="cell" data-teacher="true" data-hash="03-boosting_cache/html/unnamed-chunk-35_00d3a6404334235bb1d669b8d7bf6d0d">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>bloc <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,<span class="fu">nrow</span>(spam),<span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(bloc)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>bloc
  1   2   3   4   5   6   7   8   9  10 
438 455 449 439 496 471 442 472 470 469 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">5678</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>spam1 <span class="ot">&lt;-</span> spam <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">type=</span><span class="fu">as.numeric</span>(type)<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>score <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow=</span><span class="fu">nrow</span>(spam),<span class="at">ncol=</span><span class="dv">4</span>) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(score) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"arbre"</span>,<span class="st">"ada"</span>,<span class="st">"logit"</span>,<span class="st">"foret"</span>)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>){</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(k)</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  ind.test <span class="ot">&lt;-</span> bloc<span class="sc">==</span>k</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  dapp <span class="ot">&lt;-</span> spam1[<span class="sc">!</span>ind.test,]</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  dtest <span class="ot">&lt;-</span> spam1[ind.test,]</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  dapp2 <span class="ot">&lt;-</span> spam[<span class="sc">!</span>ind.test,]</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  dtest2 <span class="ot">&lt;-</span> spam[ind.test,]</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  arbre <span class="ot">&lt;-</span> <span class="fu">rpart</span>(type<span class="sc">~</span>.,<span class="at">data=</span>dapp2,<span class="at">cp=</span><span class="fl">1e-8</span>,<span class="at">minsplit=</span><span class="dv">2</span>)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  cp_opt <span class="ot">&lt;-</span> arbre<span class="sc">$</span>cptable <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(xerror<span class="sc">==</span><span class="fu">min</span>(xerror)) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(CP) <span class="sc">|&gt;</span> </span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>()</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>  arbre.opt <span class="ot">&lt;-</span> <span class="fu">prune</span>(arbre,<span class="at">cp=</span>cp_opt)</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>  ada <span class="ot">&lt;-</span> <span class="fu">gbm</span>(type<span class="sc">~</span>.,<span class="at">data=</span>dapp,<span class="at">distribution=</span><span class="st">"adaboost"</span>,</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">interaction.depth=</span><span class="dv">3</span>,<span class="at">bag.fraction=</span><span class="dv">1</span>,</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>             <span class="at">shrinkage =</span> <span class="fl">0.05</span>,</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>             <span class="at">cv.folds =</span> <span class="dv">5</span>,<span class="at">n.trees=</span><span class="dv">500</span>)</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>  nb_ada <span class="ot">&lt;-</span> <span class="fu">gbm.perf</span>(ada,<span class="at">plot.it=</span><span class="cn">FALSE</span>)</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>  logit <span class="ot">&lt;-</span> <span class="fu">gbm</span>(type<span class="sc">~</span>.,<span class="at">data=</span>dapp,<span class="at">distribution=</span><span class="st">"bernoulli"</span>,</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>               <span class="at">interaction.depth=</span><span class="dv">3</span>,<span class="at">bag.fraction=</span><span class="dv">1</span>,</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>               <span class="at">cv.folds =</span> <span class="dv">5</span>,<span class="at">n.trees=</span><span class="dv">800</span>)</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>  nb_logit <span class="ot">&lt;-</span> <span class="fu">gbm.perf</span>(logit,<span class="at">plot.it=</span><span class="cn">FALSE</span>)</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>  foret <span class="ot">&lt;-</span> <span class="fu">ranger</span>(type<span class="sc">~</span>.,<span class="at">data=</span>dapp2,<span class="at">probability=</span><span class="cn">TRUE</span>)</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>  score[ind.test,] <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">arbre=</span><span class="fu">predict</span>(arbre,<span class="at">newdata=</span>dtest,</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">type=</span><span class="st">"prob"</span>)[,<span class="dv">2</span>],</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>                             <span class="at">ada=</span><span class="fu">predict</span>(ada,<span class="at">newdata=</span>dtest,</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">n.trees=</span>nb_ada,</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">type=</span><span class="st">"response"</span>),</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>                             <span class="at">logit=</span><span class="fu">predict</span>(logit,<span class="at">newdata=</span>dtest,</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">n.trees=</span>nb_logit,</span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">type=</span><span class="st">"response"</span>),</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>                             <span class="at">foret=</span><span class="fu">predict</span>(foret,</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">data=</span>dtest)<span class="sc">$</span>prediction[,<span class="dv">2</span>])</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>score1 <span class="ot">&lt;-</span> score <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">obs=</span>spam<span class="sc">$</span>type) <span class="sc">|&gt;</span> </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>obs,<span class="at">names_to=</span><span class="st">"Methode"</span>,<span class="at">values_to=</span><span class="st">"score"</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>score1 <span class="sc">|&gt;</span> <span class="fu">group_by</span>(Methode) <span class="sc">|&gt;</span> </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(<span class="at">truth=</span>obs,score,<span class="at">event_level=</span><span class="st">"second"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>score1 <span class="sc">|&gt;</span> <span class="fu">group_by</span>(Methode) <span class="sc">|&gt;</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_auc</span>(<span class="at">truth=</span>obs,score,<span class="at">event_level=</span><span class="st">"second"</span>) <span class="sc">|&gt;</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(.estimate))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
  Methode .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 logit   roc_auc binary         0.988
2 foret   roc_auc binary         0.986
3 ada     roc_auc binary         0.985
4 arbre   roc_auc binary         0.912</code></pre>
</div>
</div></li>
</ol>
</section>
<section id="xgboost" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="xgboost"><span class="header-section-number">3.4</span> Xgboost</h2>
<p>L’algorithme <strong>xgboost</strong> <span class="citation" data-cites="Chen2016">Chen et Guestrin (<a href="references.html#ref-Chen2016" role="doc-biblioref">2016</a>)</span> va plusloin que le <strong>gradient boosting</strong> en minimisant une approximation à l’odre 2 de la fonction de perte et en ajoutant un terme de régularisation dans la fonction objectif. On cherche toujours des combinaisons d’arbres</p>
<p><span class="math display">\[f_b(x)=f_{b-1}(x)+h_b(x)\quad\text{où}\quad h_b(x)=w_{q(x)}\]</span></p>
<p>est un arbre à <span class="math inline">\(T\)</span> feuilles : <span class="math inline">\(w\in\mathbb R^T\)</span> et <span class="math inline">\(q:\mathbb R^d\to\{1,2,\dots,T\}\)</span>. À l’étape <span class="math inline">\(b\)</span>, on cherche l’arbre qui minimise la <strong>fonction objectif</strong> de la forme</p>
<p><span class="math display">\[
    \begin{aligned}
      \text{obj}^{(b)}= &amp; \sum_{i=1}^n\ell(y_i,f_b(x_i))+\sum_{j=1}^b\Omega(h_j) \\
      = &amp; \sum_{i=1}^n\ell(y_i,f_{b-1}(x_i)+h_b(x_i))+\sum_{j=1}^b\Omega(h_j)
    \end{aligned}
\]</span></p>
<p>où <span class="math inline">\(\Omega(h_j)\)</span> est un terme de <strong>régularisation</strong> qui va pénaliser <span class="math inline">\(h_j\)</span> en fonction de son nombre de feuilles <span class="math inline">\(T\)</span> et des valeurs prédites <span class="math inline">\(w\)</span>. Un développement limité à l’ordre 2 permet d’approcher cette fonction par</p>
<p><span class="math display">\[\text{obj}^{(b)}=\sum_{i=1}^n[\ell_i^{(1)}h_b(x_i)+\frac{1}{2}\ell_i^{(2)}h_b^2(x_i)]+\Omega(h_b)+\text{constantes},\]</span> avec</p>
<p><span class="math display">\[\ell_i^{(1)}=\frac{\partial \ell(y_i,f(x))}{\partial f(x)}(f_{b-1}(x_i))\quad\text{et}\quad \ell_i^{(2)}=\frac{\partial^2 \ell(y_i,f(x))}{\partial f(x)^2}(f_{b-1}(x_i)).\]</span> Pour les arbres, la fonction de régularisation a la forme suivante :</p>
<p><span class="math display">\[\Omega(h)=\Omega(T,w)=\gamma T+\frac{1}{2}\lambda\sum_{j=1}^Tw_j^2,\]</span> où <span class="math inline">\(\gamma\)</span> et <span class="math inline">\(\lambda\)</span> contrôlent le <strong>poids</strong> que l’on donne aux paramètres de l’arbre. On obtient au final l’algorithme suivant</p>
<div class="algo">
<ol type="1">
<li><p>Initialisation <span class="math inline">\(f_0=h_0\)</span>.</p></li>
<li><p>Pour <span class="math inline">\(b=1,\dots,B\)</span></p>
<ol type="a">
<li><p>Ajuster un arbre <span class="math inline">\(h_b\)</span> à <span class="math inline">\(T\)</span> feuilles qui minimise <span class="math display">\[\sum_{i=1}^n[\ell_i^{(1)}h_b(x_i)+\frac{1}{2}\ell_i^{(2)}h_b^2(x_i)]+\gamma T+\frac{1}{2}\lambda\sum_{j=1}^Tw_j.\]</span></p></li>
<li><p>Mettre à jour <span class="math display">\[f_b(x)=f_{b-1}(x)+h_b(x).\]</span></p></li>
</ol></li>
<li><p>Sortie : la suite d’algorithmes <span class="math inline">\((f_b)_b\)</span>.</p></li>
</ol>
</div>
<p>On pourra trouver plus de précisions ici : <a href="https://xgboost.readthedocs.io/en/stable/tutorials/index.html" class="uri">https://xgboost.readthedocs.io/en/stable/tutorials/index.html</a></p>
<div id="exr-egboost-sinus" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercice 3.1 (Prise en main des principales fonction de xgboost) </strong></span>On commence par charger le package</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>et on reprend les données sur le <strong>sinus</strong> de la <a href="#sec-sinusgbm"><span>Section&nbsp;3.1</span></a> :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>pi,<span class="dv">2</span><span class="sc">*</span>pi,<span class="at">by=</span><span class="fl">0.01</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">sin</span>(x)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">200</span>,<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>pi,<span class="dv">2</span><span class="sc">*</span>pi)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">sin</span>(X)<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">200</span>,<span class="at">sd=</span><span class="fl">0.2</span>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>df1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(X,Y)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">X=</span>x,<span class="at">Y=</span>y)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>La fonction <code>xgboost</code> requiert que les données possèdent la classe <code>xgb.DMatrix</code>, on peut l’obtenir avec</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>X_mat <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="fu">as.matrix</span>(df1[,<span class="dv">1</span>]),<span class="at">label=</span>df1<span class="sc">$</span>Y)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li><p>Expliquer la sortie</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>boost1 <span class="ot">&lt;-</span> <span class="fu">xgboost</span>(<span class="at">data=</span>X_mat,<span class="at">nrounds =</span> <span class="dv">5</span>,</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">params=</span><span class="fu">list</span>(<span class="at">objective=</span><span class="st">"reg:squarederror"</span>))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] train-rmse:0.633250 
[2] train-rmse:0.468674 
[3] train-rmse:0.354599 
[4] train-rmse:0.275842 
[5] train-rmse:0.224803 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>boost1</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>##### xgb.Booster
raw: 16.5 Kb 
call:
  xgb.train(params = params, data = dtrain, nrounds = nrounds, 
    watchlist = watchlist, verbose = verbose, print_every_n = print_every_n, 
    early_stopping_rounds = early_stopping_rounds, maximize = maximize, 
    save_period = save_period, save_name = save_name, xgb_model = xgb_model, 
    callbacks = callbacks)
params (as set within xgb.train):
  objective = "reg:squarederror", validate_parameters = "TRUE"
xgb.attributes:
  niter
callbacks:
  cb.print.evaluation(period = print_every_n)
  cb.evaluation.log()
niter: 5
nfeatures : 1 
evaluation_log:
 iter train_rmse
    1  0.6332497
    2  0.4686737
    3  0.3545990
    4  0.2758424
    5  0.2248031</code></pre>
</div>
</div>
<div class="corR">
<p>On a ici entraîné <code>xgboost</code> avec la fonction de perte quadratique et 5 itérations.</p>
</div></li>
<li><p>Faire la même chose avec 100 itération et un <code>learning rate</code> de 0.1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>boost2 <span class="ot">&lt;-</span> <span class="fu">xgboost</span>(<span class="at">data=</span>X_mat,<span class="at">nrounds =</span> <span class="dv">100</span>,</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">params=</span><span class="fu">list</span>(<span class="at">objective=</span><span class="st">"reg:squarederror"</span>,<span class="at">eta=</span><span class="fl">0.1</span>),</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>On peut obtenir les valeurs prédites entre <span class="math inline">\(-2\pi\)</span> et <span class="math inline">\(2\pi\)</span> pour 100 itérations avec</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>Xtest <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(df2<span class="sc">$</span>X)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>prev100 <span class="ot">&lt;-</span> <span class="fu">predict</span>(boost2,<span class="at">newdata=</span>Xtest,<span class="at">iterationrange =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">101</span>))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Tracer les estimateurs <strong>xgboost</strong> pour 1 itération, 20 itérations et 100 itérations. Commenter.</p>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>prev1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(boost2,<span class="at">newdata=</span>Xtest,<span class="at">iterationrange=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>prev20 <span class="ot">&lt;-</span> <span class="fu">predict</span>(boost2,<span class="at">newdata=</span>Xtest,<span class="at">iterationrange=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">21</span>))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>tbl <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x=</span>df2<span class="sc">$</span>X,<span class="at">vraie=</span>df2<span class="sc">$</span>Y,<span class="at">b1=</span>prev1,<span class="at">b20=</span>prev20,<span class="at">b100=</span>prev100) <span class="sc">|&gt;</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>x,<span class="at">names_to =</span> <span class="st">"fonc"</span>,<span class="at">values_to =</span> <span class="st">"valeurs"</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(tbl)<span class="sc">+</span><span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>valeurs,<span class="at">color=</span>fonc)<span class="sc">+</span><span class="fu">geom_line</span>()</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="corR">
<p>Comme pour le gradient boosting, l’algorithme sous-apprend si le nombre d’arbres est trop petit et sur-apprend lorsqu’il est trop grand.</p>
</div></li>
<li><p>Commenter la sortie</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>sel.xgb <span class="ot">&lt;-</span> <span class="fu">xgb.cv</span>(<span class="at">data =</span> X_mat,</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nrounds =</span> <span class="dv">100</span>, <span class="at">objective =</span> <span class="st">"reg:squarederror"</span>, </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">eval_metric =</span> <span class="st">"rmse"</span>,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nfold=</span><span class="dv">5</span>,<span class="at">eta=</span><span class="fl">0.1</span>,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">early_stopping_rounds=</span><span class="dv">10</span>,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">verbose=</span><span class="cn">FALSE</span>)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>sel.xgb<span class="sc">$</span>evaluation_log <span class="sc">|&gt;</span> <span class="fu">head</span>()</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   iter train_rmse_mean train_rmse_std test_rmse_mean test_rmse_std
1:    1       0.7894653    0.012973111      0.7906004    0.05513590
2:    2       0.7189852    0.011889426      0.7228767    0.05364182
3:    3       0.6556685    0.010877136      0.6607388    0.05284791
4:    4       0.5985454    0.010104324      0.6055111    0.05240736
5:    5       0.5471973    0.009379501      0.5567722    0.05117564
6:    6       0.5007942    0.008971210      0.5129458    0.04971156</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>(ite.opt.xgb <span class="ot">&lt;-</span> sel.xgb<span class="sc">$</span>best_iteration)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 27</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>sel.xgb<span class="sc">$</span>niter</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 37</code></pre>
</div>
</div>
<div class="corR">
<p>On effectue une validation croisée 5 blocs pour choisir le nombre d’itérations. L’argument <code>early_stopping_rounds=10</code> permet de stopper l’algorithme lorsque l’erreur de prévision commence à trop remonter.</p>
</div></li>
<li><p>Tracer les prévisions pour l’algorithme sélectionné.</p>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>prev_opt <span class="ot">&lt;-</span> <span class="fu">predict</span>(boost2,<span class="at">newdata=</span>Xtest,</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">iterationrange=</span><span class="fu">c</span>(<span class="dv">1</span>,ite.opt.xgb))</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>tbl <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x=</span>df2<span class="sc">$</span>X,<span class="at">vraie=</span>df2<span class="sc">$</span>Y,<span class="at">bopt=</span>prev_opt) <span class="sc">|&gt;</span> </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>x,<span class="at">names_to =</span> <span class="st">"fonc"</span>,<span class="at">values_to =</span> <span class="st">"valeurs"</span>)</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(tbl)<span class="sc">+</span><span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>valeurs,<span class="at">color=</span>fonc)<span class="sc">+</span><span class="fu">geom_line</span>()</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid" width="672"></p>
</div>
</div></li>
</ol>
</div>
<div id="exr-xgboostspam" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercice 3.2 (Xgboost sur les données spam) </strong></span>On reprend les données spam de la <a href="#sec-gbmspam"><span>Section&nbsp;3.2</span></a>. Entraîner un algorithme <strong>xgboost</strong> avec la fonction de perte <code>binary:logistic</code> et en sélectionnant la nombre d’itérations par validation croisée en optimisant l’AUC. <strong>Attention</strong> cette fonction de perte requiert que la variable à expliquer prenne pour valeurs 0 ou 1 en classe <code>numeric</code>.</p>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>spam1 <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(spam) <span class="sc">|&gt;</span> </span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type=</span><span class="fu">as.numeric</span>(<span class="fu">fct_recode</span>(type,<span class="st">`</span><span class="at">1</span><span class="st">`</span><span class="ot">=</span><span class="st">"spam"</span>,<span class="st">`</span><span class="at">0</span><span class="st">`</span><span class="ot">=</span><span class="st">"nonspam"</span>))<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>X_mat <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(<span class="fu">as.matrix</span>(spam1[,<span class="dv">1</span><span class="sc">:</span><span class="dv">56</span>]),<span class="at">label=</span>spam1<span class="sc">$</span>type)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="corR">
<p>On teste la fonction <code>xgboost</code> pour voir si les donées sont au bon format.</p>
</div>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>boost1 <span class="ot">&lt;-</span> <span class="fu">xgboost</span>(<span class="at">data=</span>X_mat,<span class="at">nrounds =</span> <span class="dv">5</span>,</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">params=</span><span class="fu">list</span>(<span class="at">objective=</span><span class="st">"binary:logistic"</span>))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] train-logloss:0.499990 
[2] train-logloss:0.387195 
[3] train-logloss:0.318618 
[4] train-logloss:0.262772 
[5] train-logloss:0.224457 </code></pre>
</div>
</div>
<div class="corR">
<p>On peut maintenant faire la valisation croisée :</p>
</div>
<div class="cell" data-teacher="true" data-hash="03-boosting_cache/html/unnamed-chunk-53_120bbe11eaeeb50439cf1819d72df614">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>sel.xgb <span class="ot">&lt;-</span> <span class="fu">xgb.cv</span>(<span class="at">data =</span> X_mat,</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nrounds =</span> <span class="dv">500</span>, <span class="at">objective =</span> <span class="st">"binary:logistic"</span>, </span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">eval_metric =</span> <span class="st">"auc"</span>,</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nfold=</span><span class="dv">5</span>,<span class="at">eta=</span><span class="fl">0.1</span>,</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">early_stopping_rounds=</span><span class="dv">10</span>,</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prediction=</span><span class="cn">TRUE</span>,</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">verbose=</span><span class="cn">FALSE</span>)</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>(ite.opt.xgb <span class="ot">&lt;-</span> sel.xgb<span class="sc">$</span>best_iteration)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 198</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>sel.xgb<span class="sc">$</span>niter</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 208</code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>sel.xgb<span class="sc">$</span>evaluation_log</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     iter train_auc_mean train_auc_std test_auc_mean test_auc_std
  1:    1      0.9500731  2.121192e-03     0.9306506 0.0034779143
  2:    2      0.9564121  4.808012e-03     0.9425352 0.0035386497
  3:    3      0.9621426  1.063738e-03     0.9493209 0.0035729044
  4:    4      0.9641394  2.185222e-03     0.9528820 0.0039124835
  5:    5      0.9677919  3.347806e-03     0.9577987 0.0064362485
 ---                                                             
204:  204      0.9995687  4.404906e-05     0.9884326 0.0009331813
205:  205      0.9995765  4.599862e-05     0.9884267 0.0009201703
206:  206      0.9995785  4.314789e-05     0.9884106 0.0009008832
207:  207      0.9995888  3.724468e-05     0.9884006 0.0009117750
208:  208      0.9995943  3.701767e-05     0.9883994 0.0009253329</code></pre>
</div>
</div>
<div class="corR">
<p>On récupère les prévisions issues de la validation croisée</p>
</div>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>score <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">prev=</span>sel.xgb<span class="sc">$</span>pred,<span class="at">obs=</span>spam<span class="sc">$</span>type)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="corR">
<p>pour tracer la courbe ROC et calculer l’AUC :</p>
</div>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>score <span class="sc">|&gt;</span> <span class="fu">roc_curve</span>(<span class="at">truth=</span>obs,prev,<span class="at">event_level=</span><span class="st">"second"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>score <span class="sc">|&gt;</span> <span class="fu">roc_auc</span>(<span class="at">truth=</span>obs,prev,<span class="at">event_level=</span><span class="st">"second"</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 roc_auc binary         0.988</code></pre>
</div>
</div>
</div>
<div id="exr-xgboosttidy" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercice 3.3 (Sélection avec tidymodels) </strong></span>Refaire l’exercice précédent avec la syntaxe <code>tidymodels</code>. On choisira notamment :</p>
<ul>
<li><p>la profondeur des arbres dans le vecteur</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">8</span>,<span class="dv">10</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>le nombre d’itérations entre 1 et 500 avec un <code>early_stopping</code> toujours égal à 10 et un learning rate à 0.05.</p></li>
</ul>
<p>On pourra consulter la page <a href="https://www.tidymodels.org/find/parsnip/" class="uri">https://www.tidymodels.org/find/parsnip/</a> pour trouver les noms de paramètre du <code>worfklow</code> et sur le tutoriel <a href="https://juliasilge.com/blog/shelter-animals/" class="uri">https://juliasilge.com/blog/shelter-animals/</a> pour la stratégie. Elle est ici de fixer le nombre d’itérations à 500 puisqu’on utilise le <strong>early stopping</strong> en séparant les données en 2. On initialisera donc le workflow avec</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>tune_spec <span class="ot">&lt;-</span> </span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">boost_tree</span>(<span class="at">tree_depth=</span><span class="fu">tune</span>(),<span class="at">trees=</span><span class="dv">500</span>,<span class="at">learn_rate=</span><span class="fl">0.05</span>,</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">stop_iter=</span><span class="dv">10</span>) <span class="sc">|&gt;</span> </span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">|&gt;</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>,<span class="at">validation=</span><span class="fl">0.2</span>) </span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>xgb_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(tune_spec) <span class="sc">|&gt;</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_formula</span>(type <span class="sc">~</span> .)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="corR">
<p>On définit la grille de paramètres et le ré-échantillonnage :</p>
</div>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">321</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>grille <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">tree_depth=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">8</span>,<span class="dv">10</span>))</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>re_ech <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(spam,<span class="at">v=</span><span class="dv">5</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="corR">
<p>On fait la validation croisée :</p>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>xgb_tidy <span class="ot">&lt;-</span> xgb_wf <span class="sc">|&gt;</span> </span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> re_ech,</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> grille,</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics=</span><span class="fu">metric_set</span>(roc_auc))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="corR">
<p>On visualise les résultats et on choisit la meilleure valeur :</p>
</div>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>xgb_tidy <span class="sc">|&gt;</span> <span class="fu">collect_metrics</span>()</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 7
  tree_depth .metric .estimator  mean     n  std_err .config             
       &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;    &lt;dbl&gt; &lt;chr&gt;               
1          1 roc_auc binary     0.981     5 0.00144  Preprocessor1_Model1
2          3 roc_auc binary     0.988     5 0.000946 Preprocessor1_Model2
3          8 roc_auc binary     0.987     5 0.000569 Preprocessor1_Model3
4         10 roc_auc binary     0.988     5 0.000862 Preprocessor1_Model4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>(best_par <span class="ot">&lt;-</span> xgb_tidy <span class="sc">|&gt;</span> <span class="fu">select_best</span>())</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  tree_depth .config             
       &lt;dbl&gt; &lt;chr&gt;               
1         10 Preprocessor1_Model4</code></pre>
</div>
</div>
<div class="corR">
<p>On finit en entraînant l’algorithme sur toute les données pur la valeur choisie :</p>
</div>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>final_xgb <span class="ot">&lt;-</span> </span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  xgb_wf <span class="sc">|&gt;</span> </span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(best_par) <span class="sc">|&gt;</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data=</span>spam)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="corR">
<p>On peut retrouver le nombre d’itérations sélectionnés par <strong>early stopping</strong> avec</p>
</div>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>mod_final <span class="ot">&lt;-</span> final_xgb<span class="sc">$</span>fit<span class="sc">$</span>fit<span class="sc">$</span>fit</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>mod_final<span class="sc">$</span>best_iteration</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 136</code></pre>
</div>
</div>
<div class="corR">
<p>On visualise enfin l’importance des variables avec</p>
</div>
<div class="cell" data-teacher="true">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>final_xgb <span class="sc">|&gt;</span> <span class="fu">extract_fit_parsnip</span>() <span class="sc">|&gt;</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vip</span>(<span class="at">num_features =</span> <span class="dv">15</span>, <span class="at">geom =</span> <span class="st">"point"</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="03-boosting_files/figure-html/unnamed-chunk-65-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-Chen2016" class="csl-entry" role="listitem">
Chen, T., et C. Guestrin. 2016. <span>«&nbsp;<span>XGBoost</span>: A Scalable Tree Boosting System&nbsp;»</span>. In <em>Proceedings of the 22nd ACM SIGKDD International Conference on Knowledge Discovery and Data Mining</em>, 785‑94. KDD ’16. New York, NY, USA: ACM. <a href="https://doi.org/10.1145/2939672.2939785">https://doi.org/10.1145/2939672.2939785</a>.
</div>
<div id="ref-fri01" class="csl-entry" role="listitem">
Friedman, J. H. 2001. <span>«&nbsp;Greedy Function Approximation: A Gradient Boosting Machine&nbsp;»</span>. <em>Annals of Statistics</em> 29: 1189‑1232.
</div>
<div id="ref-rid06" class="csl-entry" role="listitem">
Ridgeway, G. 2006. <span>«&nbsp;Generalized boosted models: A guide to the gbm package&nbsp;»</span>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copié");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copié");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./02-forets.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Forêts aléatoires</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link">
        <span class="nav-page-text">Références</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>